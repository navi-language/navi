use std.net.http;
use std.env;
use test_harness;
use std.io;

test "request" {
    let server = test_harness.start_http_server();
    test_harness.sleep(1.0);

    assert_eq server.addr.contains("127.0.0.1"), true, server.addr;

    // GET
    let headers = http.new_headers();
    let body = "".bytes();

    let query = <string, string> { "foo": "1", "bar": "Foo Bar" };

    let res = http.request("GET", server.url("/get"), headers: headers, query: query, body: body);
    assert_eq res.status, 200, res.text();
    assert_eq res.headers.get("Content-Type"), "application/json; charset=utf-8";
    assert_eq res.body.to_string().contains("headers"), true;

    // POST
    let body = "Hello, world!".bytes();
    let res = http.request("POST", server.url("/post"), headers: headers, body: body, query: query);
    assert_eq res.status, 200;
    assert_eq res.text().contains("Hello, world!"), true, res.text();
    assert_eq res.body.to_string(), res.text();

    // PUT
    let body = "Hello, world!".bytes();
    let res = http.request("PUT", server.url("/put"), headers: headers, query: query, body: body);
    assert_eq res.status, 200;
    assert_eq res.text().contains("Hello, world!"), true;

    // DELETE
    let body = "Hello, world!".bytes();
    let res = http.request(
        "DELETE",
        server.url("/delete"),
        headers: headers,
        query: query,
        body: body
    );
    assert_eq res.status, 200;
    assert_eq res.text().contains("Hello, world!"), true;

    /// PATCH
    let body = "Hello, world!".bytes();
    let res = http.request(
        "PATCH",
        server.url("/patch"),
        headers: headers,
        query: query,
        body: body
    );
    assert_eq res.status, 200;
    assert_eq res.text().contains("Hello, world!"), true;

    /// HEAD
    let body = "".bytes();
    let res = http.request("HEAD", server.url("/get"), headers: headers, query: query, body: body);
    assert_eq res.status, 200;
}

test "request with kw_args" {
    let server = test_harness.start_http_server();

    let res = http.request("GET", server.url("/get"));
    assert_eq res.status, 200;

    let headers = http.new_headers();
    headers.set("FOO", "test-header");
    let res = http.request("GET", server.url("/get"), headers: headers);
    assert_eq res.status, 200;
    assert_eq res.text().contains("test-header"), true;

    let query = <string, string> { "bar": "1", "foo": "FOO_BAR" };
    let res = http.request("GET", server.url("/get"), headers: headers, query: query);
    assert_eq res.status, 200;
    assert_eq res.text().contains(server.url("/get?bar=1&foo=FOO_BAR")), true, res.text();
}

test "head" {
    let server = test_harness.start_http_server();

    let headers = http.new_headers();
    let query = <string, string> { "foo": "1", "bar": "Foo Bar" };
    let res = http.head(server.url("/get"), headers: headers, query: query);
    assert_eq res.status, 200;
}

test "get" {
    let server = test_harness.start_http_server();

    let headers = http.new_headers();
    let query = <string, string> {
        "foo": "1",
        "bar": "Foo Bar",
        // same key twice
        "foo": "a"
    };
    let res = http.get(server.url("/get"), headers: headers, query: query);
    assert_eq res.status, 200;
    assert_eq res.headers.get("Content-Type"), "application/json; charset=utf-8";
    // Test query key order
    assert_eq res.text().contains(server.url("/get?bar=Foo+Bar&foo=a")), true, res.text();
    assert_eq res.json().get("url")?.string(), server.url("/get?bar=Foo+Bar&foo=a"), res.text();
}

test "post" {
    let server = test_harness.start_http_server();

    let headers = http.new_headers();
    let body = "Hello, world!".bytes();
    let res = http.post(server.url("/post"), headers: headers, body: body);
    assert_eq res.status, 200;
    assert_eq res.text().contains("Hello, world!"), true;

    let res = http.post(
        server.url("/post"),
        headers: headers,
        query: <string, string> { "foo": "1", "bar": "Foo Bar" },
        body: body
    );
    assert_eq res.status, 200;
    assert_eq res.json().get("data")?.string(), `Hello, world!`, res.text();
    assert_eq res.json().get("url")?.string(), server.url("/post?bar=Foo+Bar&foo=1"), res.text();
}

test "delete" {
    let server = test_harness.start_http_server();

    let headers = http.new_headers();
    let body = "Hello, world!".bytes();
    let res = http.delete(server.url("/delete"), headers: headers, body: body);
    assert_eq res.status, 200;
    assert_eq res.text().contains("Hello, world!"), true;
}

test "put" {
    let server = test_harness.start_http_server();

    let headers = http.new_headers();
    let body = "Hello, world!".bytes();
    let res = http.put(server.url("/put"), headers: headers, body: body);
    assert_eq res.status, 200;
    assert_eq res.text().contains("Hello, world!"), true;
}

test "patch" {
    let server = test_harness.start_http_server();

    let headers = http.new_headers();
    let body = "Hello, world!".bytes();
    let res = http.patch(server.url("/patch"), headers: headers, body: body);
    assert_eq res.status, 200;
    assert_eq res.text().contains("Hello, world!"), true;
}
